import * as SDK from '@expressms/smartapp-sdk'
import { RootStore } from '../../store/rootStore'
import { File, STATUS, StatusResponse } from '@expressms/smartapp-sdk/build/main/types'
import { makeAutoObservable } from 'mobx'

export class AntimalwareStore {
  rootStore: RootStore

  constructor(rootStore: RootStore) {
    makeAutoObservable(this)

    this.rootStore = rootStore
  }

  async openFile(infected: boolean): Promise<void> {
    try {
      const response = (await SDK.Bridge?.sendBotEvent({
        method: 'get_example_file',
        params: {
          fileType: infected ? 'infected' : 'regular',
        },
      })) as StatusResponse

      if (response.payload.status === STATUS.ERROR) {
        this.rootStore.toastStore.showToast(`Ошибка получения файла ${JSON.stringify(response.payload)}`)
        return
      }

      const [file] = response.files as File[]
      await SDK.openFile(file)
    } catch (e) {
      this.rootStore.toastStore.showToast(`Ошибка получения файла ${e?.message}`)
    }
  }
}
